<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garbage Detection System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .detection-card {
            transition: all 0.3s ease;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
        }
        .detection-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .drop-zone {
            border: 2px dashed #4CAF50;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            background: rgba(76, 175, 80, 0.05);
        }
        .drop-zone.dragover {
            background-color: rgba(76, 175, 80, 0.1);
            border-color: #45a049;
            transform: scale(1.02);
        }
        .webcam-container {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .webcam-controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }
        .processing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            border-radius: 15px;
        }
        .progress-bar {
            width: 80%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }
        .video-container {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .video-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        .nav-button {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .nav-button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: #4CAF50;
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        .nav-button.active::after {
            transform: scaleX(1);
        }
        .video-controls {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }
        .buffering-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
            z-index: 10;
        }
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Garbage Detection System</h1>
                        <p class="mt-2 text-gray-600">AI-powered waste detection and classification</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">Live</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Tabs -->
            <div class="bg-white rounded-xl shadow-sm p-4 mb-8">
                <div class="flex space-x-8">
                    <button onclick="switchTab('webcam')" class="nav-button px-4 py-2 text-gray-700 font-medium active">
                        <i class="fas fa-video mr-2"></i>Webcam Detection
                    </button>
                    <button onclick="switchTab('video')" class="nav-button px-4 py-2 text-gray-700 font-medium">
                        <i class="fas fa-film mr-2"></i>Video Detection
                    </button>
                    <button onclick="switchTab('photo')" class="nav-button px-4 py-2 text-gray-700 font-medium">
                        <i class="fas fa-image mr-2"></i>Photo Detection
                    </button>
                    <button onclick="switchTab('logs')" class="nav-button px-4 py-2 text-gray-700 font-medium">
                        <i class="fas fa-clipboard-list mr-2"></i>Detection Logs
                    </button>
                </div>
            </div>

            <!-- Webcam Tab -->
            <div id="webcam" class="tab-content active">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Live Webcam Feed</h2>
                        <div class="webcam-container aspect-w-16 aspect-h-9">
                            <img id="webcamFeed" src="" class="w-full h-full object-cover" alt="Camera Feed">
                            <div class="webcam-controls">
                                <button id="startWebcam" class="bg-green-600 text-white px-6 py-3 rounded-lg mr-4 hover:bg-green-700 transition shadow-md">
                                    <i class="fas fa-play mr-2"></i>Start Detection
                                </button>
                                <button id="stopWebcam" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition shadow-md" disabled>
                                    <i class="fas fa-stop mr-2"></i>Stop Detection
                                </button>
                            </div>
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button onclick="switchTab('logs')" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition shadow-md">
                                <i class="fas fa-clipboard-list mr-2"></i>View Detection Logs
                            </button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Recent Detections</h2>
                        <div id="recentDetections" class="space-y-4 max-h-[600px] overflow-y-auto">
                            <!-- Recent detections will be populated here -->
                            <p class="text-gray-500 text-center py-4">No recent detections</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs Tab (New) -->
            <div id="logs-tab" class="tab-content">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Detection Logs</h2>
                    <div id="logs-container" class="space-y-4 max-h-[600px] overflow-y-auto">
                        <!-- Logs will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Video Tab -->
            <div id="video" class="tab-content">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Video Detection</h2>
                    <div class="drop-zone mb-6" id="videoDropZone">
                        <i class="fas fa-cloud-upload-alt text-4xl text-green-600 mb-4"></i>
                        <p class="text-gray-600 mb-2">Drag and drop a video file here</p>
                        <p class="text-sm text-gray-500 mb-4">or</p>
                        <input type="file" id="videoInput" accept="video/*" class="hidden">
                        <button onclick="document.getElementById('videoInput').click()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">
                            <i class="fas fa-folder-open mr-2"></i>Select Video
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="video-container">
                            <div class="video-label">Original Video</div>
                            <video id="videoPlayer" controls class="w-full h-full object-cover hidden"></video>
                        </div>
                        <div class="video-container">
                            <div class="video-label">Processed Video</div>
                            <video id="processedVideoPlayer" controls class="w-full h-full object-cover hidden" controlsList="nodownload">
                                <!-- Remove the source tag and set the src attribute directly on the video element -->
                            </video>
                            <div id="videoProcessing" class="buffering-spinner hidden"></div>
                            <div class="video-controls">
                                <button id="downloadProcessedVideo" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition hidden">
                                    <i class="fas fa-download mr-2"></i>Download Processed Video
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Photo Tab -->
            <div id="photo" class="tab-content">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Photo Detection</h2>
                    
                    <!-- Location Input Section -->
                    <div class="mb-6 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-medium mb-3 text-gray-800">
                            <i class="fas fa-map-marker-alt text-green-600 mr-2"></i>Location Information
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="locationName" class="block text-sm font-medium text-gray-700 mb-1">Location Name</label>
                                <input type="text" id="locationName" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" placeholder="e.g. Main Entrance, Building A">
                            </div>
                            <div>
                                <label for="manualCoordinates" class="block text-sm font-medium text-gray-700 mb-1">Manual Coordinates (optional)</label>
                                <input type="text" id="manualCoordinates" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" placeholder="e.g. 12.345, -67.890">
                            </div>
                        </div>
                        <div class="mt-4 flex items-center">
                            <button id="getCurrentLocation" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                <i class="fas fa-crosshairs mr-2"></i>Get Current Location
                            </button>
                            <div id="locationStatus" class="ml-4 text-sm"></div>
                        </div>
                    </div>
                    
                    <div class="drop-zone mb-6" id="photoDropZone">
                        <i class="fas fa-cloud-upload-alt text-4xl text-green-600 mb-4"></i>
                        <p class="text-gray-600 mb-2">Drag and drop a photo here</p>
                        <p class="text-sm text-gray-500 mb-4">or</p>
                        <input type="file" id="photoInput" accept="image/*" class="hidden">
                        <button onclick="document.getElementById('photoInput').click()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">
                            <i class="fas fa-folder-open mr-2"></i>Select Photo
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-md font-medium mb-2 text-gray-800">Original Photo</h3>
                            <div class="relative border rounded-lg overflow-hidden">
                                <img id="originalPhoto" src="#" alt="Original photo" class="w-full h-64 object-contain hidden">
                                <div id="photoPlaceholder" class="w-full h-64 bg-gray-100 flex items-center justify-center">
                                    <span class="text-gray-400"><i class="fas fa-image text-2xl"></i></span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-md font-medium mb-2 text-gray-800">Processed Photo</h3>
                            <div class="relative border rounded-lg overflow-hidden">
                                <img id="processedPhoto" src="#" alt="Processed photo" class="w-full h-64 object-contain hidden">
                                <div id="processedPhotoPlaceholder" class="w-full h-64 bg-gray-100 flex items-center justify-center">
                                    <span class="text-gray-400"><i class="fas fa-image text-2xl"></i></span>
                                </div>
                                <div id="photoProcessing" class="processing-overlay hidden">
                                    <i class="fas fa-cog fa-spin text-4xl mb-4"></i>
                                    <p class="text-xl mb-2">Processing Photo...</p>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill" id="photoProgressBar"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <div id="photoDetectionResult" class="hidden bg-green-50 border border-green-200 text-green-800 p-4 rounded-lg"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <script>
        // Function to format timestamp
        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString();
        }

        // Function to create a log card
        function createLogCard(log) {
            return `
                <div class="detection-card p-4 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-green-600">${log.class}</span>
                        <span class="text-sm text-gray-500">${formatTimestamp(log.timestamp)}</span>
                    </div>
                    <div class="mt-2">
                        <span class="text-sm text-gray-600">Confidence: ${(log.confidence * 100).toFixed(1)}%</span>
                    </div>
                </div>
            `;
        }

        // Function to update logs
        function updateLogs() {
            fetch('/get_logs')
                .then(response => response.json())
                .then(data => {
                    const logsContainer = document.getElementById('logs-container');
                    logsContainer.innerHTML = '';
                    
                    if (data.length === 0) {
                        logsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No detections yet</p>';
                        return;
                    }
                    
                    // Only show logs marked for cleaning
                    const cleaningLogs = data.filter(log => log.forCleaning);
                    
                    if (cleaningLogs.length === 0) {
                        logsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No cleaning tasks yet</p>';
                        return;
                    }
                    
                    cleaningLogs.forEach(log => {
                        const logItem = document.createElement('div');
                        logItem.className = 'detection-card bg-white p-4 rounded-lg shadow-sm';
                        
                        // Fix image path display
                        const imagePath = log.image_path ? ('/' + log.image_path) : '';
                        
                        logItem.innerHTML = `
                            <div class="flex items-center">
                                <div class="w-20 h-20 mr-4 overflow-hidden rounded-lg">
                                    <img src="${imagePath}" class="w-full h-full object-cover" alt="Detection" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-800">${log.class}</h3>
                                    <p class="text-sm text-gray-600">Confidence: ${log.confidence}</p>
                                    <p class="text-xs text-gray-500">Time: ${log.timestamp}</p>
                                    <div class="mt-2 flex items-center">
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" class="form-checkbox h-4 w-4 text-green-600" 
                                                   ${log.status === 'cleaned' ? 'checked' : ''}
                                                   onchange="updateStatus('${log.timestamp}', this.checked ? 'cleaned' : 'pending')">
                                            <span class="ml-2 text-sm text-gray-700">Cleaned</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        logsContainer.appendChild(logItem);
                    });
                })
                .catch(error => {
                    console.error('Error fetching logs:', error);
                });
        }

        // Function to update the status of a detection
        function updateStatus(timestamp, status) {
            fetch('/update_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    timestamp: timestamp,
                    status: status
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Status updated:', data);
            })
            .catch((error) => {
                console.error('Error updating status:', error);
            });
        }

        // Function to switch tabs
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            if (tabName === 'logs') {
                document.getElementById('logs-tab').classList.add('active');
            } else {
                document.getElementById(tabName).classList.add('active');
            }
            
            // Update tab buttons
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active', 'text-green-600');
                button.classList.add('text-gray-700');
            });
            
            // Highlight selected tab button
            const selectedButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            selectedButton.classList.remove('text-gray-700');
            selectedButton.classList.add('active', 'text-green-600');
            
            // Refresh logs if logs tab is selected
            if (tabName === 'logs') {
                updateLogs();
            }
        }

        // Webcam controls
        let webcamActive = false;
        const webcamFeed = document.getElementById('webcamFeed');
        const startWebcam = document.getElementById('startWebcam');
        const stopWebcam = document.getElementById('stopWebcam');

        // Don't initialize webcam feed on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Setup webcam start/stop buttons
            const startWebcamBtn = document.getElementById('startWebcam');
            const stopWebcamBtn = document.getElementById('stopWebcam');
            const webcamFeed = document.getElementById('webcamFeed');
            
            startWebcamBtn.addEventListener('click', function() {
                // Set the src attribute to the video feed URL
                webcamFeed.src = "/video_feed";
                webcamFeed.style.display = 'block';
                
                // Toggle button states
                startWebcamBtn.disabled = true;
                stopWebcamBtn.disabled = false;
                
                // Start fetching detections more frequently during webcam use
                fetchDetections();
                const detectionInterval = setInterval(fetchDetections, 3000);
                webcamFeed.setAttribute('data-interval', detectionInterval);
            });
            
            stopWebcamBtn.addEventListener('click', function() {
                // Clear the webcam feed source
                webcamFeed.src = "";
                
                // Toggle button states
                startWebcamBtn.disabled = false;
                stopWebcamBtn.disabled = true;
                
                // Clear the detection interval
                const detectionInterval = webcamFeed.getAttribute('data-interval');
                if (detectionInterval) {
                    clearInterval(parseInt(detectionInterval));
                }
            });
            
            // Just fetch detections for the recent lists
            fetchDetections();
            setInterval(fetchDetections, 5000);
            
            // Setup drag and drop for photo uploads
            setupDropZone(
                document.getElementById('photoDropZone'),
                document.getElementById('photoInput'),
                handlePhotoUpload
            );
            
            // Setup drag and drop for video uploads 
            const videoDropZone = document.getElementById('videoDropZone');
            const videoInput = document.getElementById('videoInput');
            
            if (videoDropZone && videoInput) {
                videoDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    videoDropZone.classList.add('dragover');
                });
                
                videoDropZone.addEventListener('dragleave', () => {
                    videoDropZone.classList.remove('dragover');
                });
                
                videoDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    videoDropZone.classList.remove('dragover');
                    
                    const file = e.dataTransfer.files[0];
                    if (file) {
                        videoInput.files = e.dataTransfer.files;
                        
                        // Handle video file
                        const url = URL.createObjectURL(file);
                        const videoPlayer = document.getElementById('videoPlayer');
                        videoPlayer.src = url;
                        videoPlayer.classList.remove('hidden');
                        
                        // Show buffering spinner
                        const processingElement = document.getElementById('videoProcessing');
                        processingElement.classList.remove('hidden');
                        
                        // Process video
                        const formData = new FormData();
                        formData.append('video', file);
                        
                        fetch('/process_video', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            processingElement.classList.add('hidden');
                            
                            // Show processed video
                            const processedVideo = document.getElementById('processedVideoPlayer');
                            processedVideo.classList.remove('hidden');
                            
                            // Direct source to the processed file path
                            if (data.processed_path) {
                                processedVideo.src = '/' + data.processed_path.replace(/\\/g, '/');
                                processedVideo.load();
                            }
                            
                            // Show download button
                            const downloadButton = document.getElementById('downloadProcessedVideo');
                            downloadButton.classList.remove('hidden');
                            downloadButton.onclick = () => {
                                // Extract filename from path
                                const filename = data.processed_path.split(/[\/\\]/).pop();
                                window.location.href = `/download_video/${filename}`;
                            };
                            
                            updateLogs();
                        })
                        .catch(error => {
                            console.error('Error processing video:', error);
                            processingElement.classList.add('hidden');
                        });
                    }
                });
            }
        });

        // Fix drag and drop functionality
        function setupDropZone(dropZone, inputElement, processingFunction) {
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                const file = e.dataTransfer.files[0];
                if (file) {
                    inputElement.files = e.dataTransfer.files;
                    processingFunction(e);
                }
            });
        }

        function handleFileUpload(file, previewElement, processingElement) {
            if (file.type.startsWith('video/')) {
                // Handle video upload (keep existing code)
                const url = URL.createObjectURL(file);
                
                // Show original video
                const videoPlayer = document.getElementById('videoPlayer');
                videoPlayer.src = url;
                videoPlayer.classList.remove('hidden');
                
                // Show buffering spinner
                const processingElement = document.getElementById('videoProcessing');
                processingElement.classList.remove('hidden');
                
                // Process video
                const formData = new FormData();
                formData.append('video', file);
                
                fetch('/process_video', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    processingElement.classList.add('hidden');
                    
                    // Show processed video - fix for video display
                    const processedVideo = document.getElementById('processedVideoPlayer');
                    processedVideo.classList.remove('hidden');
                    
                    // Direct source to the processed file path
                    if (data.processed_path) {
                        processedVideo.src = '/' + data.processed_path.replace(/\\/g, '/');
                        processedVideo.load();
                    }
                    
                    // Show download button
                    const downloadButton = document.getElementById('downloadProcessedVideo');
                    downloadButton.classList.remove('hidden');
                    downloadButton.onclick = () => {
                        // Extract filename from path
                        const filename = data.processed_path.split(/[\/\\]/).pop();
                        window.location.href = `/download_video/${filename}`;
                    };
                    
                    updateLogs();
                })
                .catch(error => {
                    console.error('Error processing video:', error);
                    processingElement.classList.add('hidden');
                });
            }
        }

        // Update the handlePhotoUpload function with better overlay handling
        function handlePhotoUpload(event) {
            const file = event.target.files?.[0] || (event.dataTransfer?.files?.[0]);
            if (!file) return;
            
            console.log("Processing photo:", file.name);
            
            // Display original photo
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('originalPhoto').src = e.target.result;
                document.getElementById('originalPhoto').classList.remove('hidden');
                document.getElementById('photoPlaceholder').classList.add('hidden');
            };
            reader.readAsDataURL(file);
            
            // Get references to UI elements
            const processingOverlay = document.getElementById('photoProcessing');
            const progressBar = document.getElementById('photoProgressBar');
            const processedPhoto = document.getElementById('processedPhoto');
            const processedPhotoPlaceholder = document.getElementById('processedPhotoPlaceholder');
            const photoDetectionResult = document.getElementById('photoDetectionResult');
            
            // Ensure the overlay is visible and reset progress
            processingOverlay.classList.remove('hidden');
            progressBar.style.width = '0%';
            
            // Animate progress bar
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 90) {
                    clearInterval(interval);
                } else {
                    width += 5;
                    progressBar.style.width = width + '%';
                }
            }, 100);
            
            // Get location information
            const locationName = document.getElementById('locationName').value;
            const coordinates = document.getElementById('manualCoordinates').value;
            let latitude = '', longitude = '';
            
            if (coordinates) {
                const coordsArray = coordinates.split(',');
                if (coordsArray.length === 2) {
                    latitude = coordsArray[0].trim();
                    longitude = coordsArray[1].trim();
                }
            }
            
            // Create form data
            const formData = new FormData();
            formData.append('photo', file);
            formData.append('location', locationName);
            formData.append('latitude', latitude);
            formData.append('longitude', longitude);
            
            console.log("Sending photo to server with location:", locationName);
            
            // Helper function to ensure the processing overlay is hidden
            const hideProcessingOverlay = () => {
                console.log("Hiding processing overlay");
                clearInterval(interval);
                progressBar.style.width = '100%';
                
                // Make sure this gets called regardless of how the function exits
                setTimeout(() => {
                    if (processingOverlay) {
                        processingOverlay.classList.add('hidden');
                        console.log("Processing overlay hidden");
                    }
                }, 500);
            };
            
            // Send to server
            fetch('/process_photo', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log("Server response received:", response.status);
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Processing complete, data:", data);
                
                // Complete progress bar
                progressBar.style.width = '100%';
                
                if (data.success) {
                    // Display processed photo
                    const processedPhotoUrl = '/' + data.processed_path + '?t=' + new Date().getTime();
                    console.log("Setting processed photo URL:", processedPhotoUrl);
                    
                    processedPhoto.src = processedPhotoUrl;
                    processedPhoto.classList.remove('hidden');
                    processedPhotoPlaceholder.classList.add('hidden');
                    
                    // Display detection results
                    if (data.detection) {
                        photoDetectionResult.classList.remove('hidden');
                        photoDetectionResult.innerHTML = `
                            <div class="flex items-start">
                                <div class="flex-shrink-0 mt-1">
                                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                                </div>
                                <div class="ml-3">
                                    <h3 class="font-semibold">Detection Results:</h3>
                                    <ul class="mt-1 list-disc list-inside">
                                        <li>Object: ${data.detection.class}</li>
                                        <li>Confidence: ${Math.round(data.detection.confidence * 100)}%</li>
                                        <li>Location: ${data.detection.location}</li>
                                        <li>Timestamp: ${data.detection.timestamp}</li>
                                    </ul>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    console.error("Error in processing:", data.error);
                    alert('Error processing photo: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error processing photo: ' + error);
            })
            .finally(() => {
                // Always hide the processing overlay, even if there are errors
                hideProcessingOverlay();
            });
        }

        // Function to fetch and display detections
        function fetchDetections() {
            fetch('/get_detections')
                .then(response => response.json())
                .then(data => {
                    // Update recent detections
                    const recentDetections = document.getElementById('recentDetections');
                    
                    // Clear previous content if empty
                    if (recentDetections.querySelector('p')) {
                        recentDetections.innerHTML = '';
                    }
                    
                    // Display the 10 most recent detections only
                    const recentItems = data.slice(0, 10);
                    
                    if (recentItems.length === 0) {
                        recentDetections.innerHTML = '<p class="text-gray-500 text-center py-4">No recent detections</p>';
                        return;
                    }
                    
                    // Clear existing detections and repopulate
                    recentDetections.innerHTML = '';
                    
                    recentItems.forEach(detection => {
                        // Create detection card using processDetection helper
                        const imagePath = detection.image_path ? ('/' + detection.image_path) : '';
                        
                        const detectionItem = document.createElement('div');
                        detectionItem.className = 'detection-card bg-white p-4 rounded-lg shadow-sm';
                        
                        detectionItem.innerHTML = `
                            <div class="flex items-center">
                                <div class="w-20 h-20 mr-4 overflow-hidden rounded-lg">
                                    <img src="${imagePath}" class="w-full h-full object-cover" alt="Detection" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-800">${detection.class}</h3>
                                    <p class="text-sm text-gray-600">Confidence: ${detection.confidence}</p>
                                    <p class="text-xs text-gray-500">Time: ${detection.timestamp}</p>
                                </div>
                            </div>
                        `;
                        
                        recentDetections.appendChild(detectionItem);
                    });
                })
                .catch(error => {
                    console.error('Error fetching detections:', error);
                });
        }

        // Geolocation functionality
        document.getElementById('getCurrentLocation').addEventListener('click', function() {
            const locationStatus = document.getElementById('locationStatus');
            locationStatus.innerHTML = '<span class="text-blue-600"><i class="fas fa-spinner fa-spin mr-1"></i> Getting location...</span>';
            
            if (!navigator.geolocation) {
                locationStatus.innerHTML = '<span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i> Geolocation not supported by your browser</span>';
                return;
            }

            navigator.geolocation.getCurrentPosition(function(position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                
                document.getElementById('manualCoordinates').value = latitude + ', ' + longitude;
                locationStatus.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i> Location acquired</span>';
            }, function(error) {
                console.error('Error getting location:', error);
                let errorMsg = 'Error getting location';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = 'Location access denied';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = 'Location information unavailable';
                        break;
                    case error.TIMEOUT:
                        errorMsg = 'Location request timed out';
                        break;
                }
                locationStatus.innerHTML = `<span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i> ${errorMsg}</span>`;
            });
        });
    </script>
</body>
</html> 